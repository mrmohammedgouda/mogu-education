// Admin Authentication & Session Management Helper Functions

// Simple password hashing (in production, use bcrypt)
function hashPassword(password: string): string {
  // For demo: simple hash. In production, use proper bcrypt
  return btoa(password + 'MOGU_SALT_2024');
}

function verifyPassword(password: string, hash: string): boolean {
  return hashPassword(password) === hash;
}

function generateSessionToken(): string {
  return btoa(Math.random().toString(36) + Date.now().toString(36));
}

// Admin Authentication Middleware
async function adminAuth(c: any, next: any) {
  const sessionToken = c.req.cookie('admin_session');
  
  if (!sessionToken) {
    return c.redirect('/admin/login');
  }

  const { DB } = c.env;
  const session = await DB.prepare(`
    SELECT s.*, u.username, u.full_name, u.role 
    FROM admin_sessions s
    JOIN admin_users u ON s.admin_id = u.id
    WHERE s.session_token = ? AND s.expires_at > datetime('now') AND u.is_active = 1
  `).bind(sessionToken).first();

  if (!session) {
    return c.redirect('/admin/login');
  }

  c.set('admin', session);
  await next();
}

// Admin Login API
app.post('/api/admin/login', async (c) => {
  const { DB } = c.env;
  const { username, password } = await c.req.json();

  try {
    const user = await DB.prepare(`
      SELECT * FROM admin_users WHERE username = ? AND is_active = 1
    `).bind(username).first();

    if (!user || !verifyPassword(password, user.password_hash)) {
      return c.json({ success: false, message: 'Invalid credentials' }, 401);
    }

    // Create session
    const sessionToken = generateSessionToken();
    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(); // 24 hours

    await DB.prepare(`
      INSERT INTO admin_sessions (admin_id, session_token, expires_at)
      VALUES (?, ?, ?)
    `).bind(user.id, sessionToken, expiresAt).run();

    // Update last login
    await DB.prepare(`
      UPDATE admin_users SET last_login = datetime('now') WHERE id = ?
    `).bind(user.id).run();

    return c.json({ 
      success: true, 
      sessionToken,
      user: {
        id: user.id,
        username: user.username,
        full_name: user.full_name,
        role: user.role
      }
    });
  } catch (error) {
    console.error('Login error:', error);
    return c.json({ success: false, message: 'Login failed' }, 500);
  }
});

// Admin Logout API
app.post('/api/admin/logout', async (c) => {
  const { DB } = c.env;
  const sessionToken = c.req.cookie('admin_session');

  if (sessionToken) {
    await DB.prepare(`DELETE FROM admin_sessions WHERE session_token = ?`)
      .bind(sessionToken).run();
  }

  return c.json({ success: true });
});

// Admin API - Get all certificates
app.get('/api/admin/certificates', async (c) => {
  const { DB } = c.env;

  try {
    const stmt = DB.prepare(`
      SELECT 
        c.id,
        c.certificate_number,
        c.holder_name,
        c.issue_date,
        c.expiry_date,
        c.status,
        p.program_name,
        p.program_code,
        tc.name as training_center
      FROM certificates c
      JOIN training_programs p ON c.program_id = p.id
      JOIN training_centers tc ON c.center_id = tc.id
      ORDER BY c.created_at DESC
    `);

    const { results } = await stmt.all();
    return c.json({ success: true, certificates: results || [] });
  } catch (error) {
    console.error('Error fetching certificates:', error);
    return c.json({ success: false, message: 'Error fetching certificates' }, 500);
  }
});

// Admin API - Add certificate
app.post('/api/admin/certificates', async (c) => {
  const { DB } = c.env;
  const data = await c.req.json();

  try {
    const result = await DB.prepare(`
      INSERT INTO certificates (certificate_number, holder_name, program_id, center_id, issue_date, expiry_date, status)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.certificate_number,
      data.holder_name,
      data.program_id,
      data.center_id,
      data.issue_date,
      data.expiry_date || null,
      data.status || 'valid'
    ).run();

    return c.json({ success: true, id: result.meta.last_row_id });
  } catch (error) {
    console.error('Error adding certificate:', error);
    return c.json({ success: false, message: 'Error adding certificate' }, 500);
  }
});

// Admin API - Update certificate
app.put('/api/admin/certificates/:id', async (c) => {
  const { DB } = c.env;
  const id = c.req.param('id');
  const data = await c.req.json();

  try {
    await DB.prepare(`
      UPDATE certificates 
      SET certificate_number = ?, holder_name = ?, program_id = ?, center_id = ?, 
          issue_date = ?, expiry_date = ?, status = ?, updated_at = datetime('now')
      WHERE id = ?
    `).bind(
      data.certificate_number,
      data.holder_name,
      data.program_id,
      data.center_id,
      data.issue_date,
      data.expiry_date || null,
      data.status,
      id
    ).run();

    return c.json({ success: true });
  } catch (error) {
    console.error('Error updating certificate:', error);
    return c.json({ success: false, message: 'Error updating certificate' }, 500);
  }
});

// Admin API - Delete certificate
app.delete('/api/admin/certificates/:id', async (c) => {
  const { DB } = c.env;
  const id = c.req.param('id');

  try {
    await DB.prepare(`DELETE FROM certificates WHERE id = ?`).bind(id).run();
    return c.json({ success: true });
  } catch (error) {
    console.error('Error deleting certificate:', error);
    return c.json({ success: false, message: 'Error deleting certificate' }, 500);
  }
});

// Admin API - Get all programs
app.get('/api/admin/programs', async (c) => {
  const { DB } = c.env;

  try {
    const stmt = DB.prepare(`
      SELECT p.*, tc.name as center_name
      FROM training_programs p
      JOIN training_centers tc ON p.center_id = tc.id
      ORDER BY p.program_name
    `);

    const { results } = await stmt.all();
    return c.json({ success: true, programs: results || [] });
  } catch (error) {
    return c.json({ success: false, message: 'Error fetching programs' }, 500);
  }
});

// Admin API - Get all centers (simple list for dropdowns)
app.get('/api/admin/centers/list', async (c) => {
  const { DB } = c.env;

  try {
    const stmt = DB.prepare(`SELECT id, name FROM training_centers WHERE accreditation_status = 'active' ORDER BY name`);
    const { results } = await stmt.all();
    return c.json({ success: true, centers: results || [] });
  } catch (error) {
    return c.json({ success: false, message: 'Error fetching centers' }, 500);
  }
});
// Admin Login Page
app.get('/admin/login', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Login - MOGU Edu</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          .gradient-bg { background: linear-gradient(135deg, #8B1D1D 0%, #1F1F1F 100%); }
        </style>
    </head>
    <body class="gradient-bg min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <img src="/mogu-logo.png" alt="MOGU Edu" class="h-16 mx-auto mb-4">
                <h1 class="text-2xl font-bold text-gray-800">Admin Login</h1>
                <p class="text-gray-600 mt-2">MOGU Education Administration Panel</p>
            </div>

            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-user mr-2"></i>Username
                    </label>
                    <input 
                        type="text" 
                        id="username"
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800"
                        placeholder="Enter your username">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-lock mr-2"></i>Password
                    </label>
                    <input 
                        type="password" 
                        id="password"
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800"
                        placeholder="Enter your password">
                </div>

                <div id="error-message" class="hidden p-3 bg-red-50 border-l-4 border-red-500 text-red-700 rounded"></div>

                <button 
                    type="submit"
                    class="w-full bg-red-800 text-white py-3 rounded-lg font-semibold hover:bg-red-900 transition">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
            </form>

            <div class="mt-6 text-center">
                <a href="/" class="text-red-800 hover:underline text-sm">
                    <i class="fas fa-arrow-left mr-1"></i>Back to Website
                </a>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
          document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error-message');

            errorDiv.classList.add('hidden');

            try {
              const response = await axios.post('/api/admin/login', { username, password });
              
              if (response.data.success) {
                document.cookie = 'admin_session=' + response.data.sessionToken + '; path=/; max-age=86400';
                window.location.href = '/admin/dashboard';
              } else {
                errorDiv.textContent = response.data.message || 'Invalid credentials';
                errorDiv.classList.remove('hidden');
              }
            } catch (error) {
              errorDiv.textContent = 'Login failed. Please check your credentials.';
              errorDiv.classList.remove('hidden');
            }
          });
        </script>
    </body>
    </html>
  `)
})

// Admin Dashboard Page
app.get('/admin/dashboard', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Dashboard - MOGU Edu</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-100">
        <!-- Admin Navigation -->
        <nav class="bg-red-800 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <img src="/mogu-logo.png" alt="MOGU Edu" class="h-12 brightness-0 invert">
                        <span class="ml-3 text-xl font-bold">Admin Panel</span>
                    </div>
                    <div class="flex items-center space-x-6">
                        <a href="/admin/dashboard" class="hover:text-gray-200 font-semibold border-b-2 border-white pb-1">
                            <i class="fas fa-home mr-1"></i>Dashboard
                        </a>
                        <a href="/admin/certificates" class="hover:text-gray-200">
                            <i class="fas fa-certificate mr-1"></i>Certificates
                        </a>
                        <a href="/admin/centers" class="hover:text-gray-200">
                            <i class="fas fa-building mr-1"></i>Centers
                        </a>
                        <a href="/admin/programs" class="hover:text-gray-200">
                            <i class="fas fa-book mr-1"></i>Programs
                        </a>
                        <button onclick="logout()" class="hover:text-gray-200">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">
                <i class="fas fa-chart-line mr-2"></i>Dashboard Overview
            </h1>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Total Certificates</p>
                            <p class="text-3xl font-bold text-gray-800" id="total-certificates">-</p>
                        </div>
                        <div class="text-4xl text-blue-500">
                            <i class="fas fa-certificate"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Active Centers</p>
                            <p class="text-3xl font-bold text-gray-800" id="total-centers">-</p>
                        </div>
                        <div class="text-4xl text-green-500">
                            <i class="fas fa-building"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Active Programs</p>
                            <p class="text-3xl font-bold text-gray-800" id="total-programs">-</p>
                        </div>
                        <div class="text-4xl text-purple-500">
                            <i class="fas fa-book"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Valid Certificates</p>
                            <p class="text-3xl font-bold text-gray-800" id="valid-certificates">-</p>
                        </div>
                        <div class="text-4xl text-green-600">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-bolt mr-2"></i>Quick Actions
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <a href="/admin/certificates?action=add" class="bg-blue-50 border-2 border-blue-200 p-4 rounded-lg hover:bg-blue-100 transition text-center">
                        <i class="fas fa-plus-circle text-3xl text-blue-600 mb-2"></i>
                        <p class="font-semibold text-blue-800">Add New Certificate</p>
                    </a>
                    <a href="/admin/centers?action=add" class="bg-green-50 border-2 border-green-200 p-4 rounded-lg hover:bg-green-100 transition text-center">
                        <i class="fas fa-building text-3xl text-green-600 mb-2"></i>
                        <p class="font-semibold text-green-800">Add Training Center</p>
                    </a>
                    <a href="/admin/programs?action=add" class="bg-purple-50 border-2 border-purple-200 p-4 rounded-lg hover:bg-purple-100 transition text-center">
                        <i class="fas fa-book text-3xl text-purple-600 mb-2"></i>
                        <p class="font-semibold text-purple-800">Add Training Program</p>
                    </a>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
          // Load statistics
          axios.get('/api/stats')
            .then(response => {
              if (response.data.success) {
                const stats = response.data.stats;
                document.getElementById('total-certificates').textContent = stats.issuedCertificates;
                document.getElementById('total-centers').textContent = stats.accreditedCenters;
                document.getElementById('total-programs').textContent = stats.accreditedPrograms;
                document.getElementById('valid-certificates').textContent = stats.issuedCertificates;
              }
            })
            .catch(error => console.error('Error loading stats:', error));

          function logout() {
            axios.post('/api/admin/logout')
              .then(() => {
                document.cookie = 'admin_session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                window.location.href = '/admin/login';
              })
              .catch(error => console.error('Logout error:', error));
          }
        </script>
    </body>
    </html>
  `)
})
// ============================================
// ADMIN CERTIFICATE MANAGEMENT PAGE
// ============================================

app.get('/admin/certificates', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Manage Certificates - MOGU Edu</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-100">
        <!-- Admin Navigation -->
        <nav class="bg-red-800 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <img src="/mogu-logo.png" alt="MOGU Edu" class="h-12">
                        <span class="ml-3 text-xl font-bold">Admin Panel</span>
                    </div>
                    <div class="flex items-center space-x-6">
                        <a href="/admin/dashboard" class="hover:text-gray-200">
                            <i class="fas fa-home mr-1"></i>Dashboard
                        </a>
                        <a href="/admin/certificates" class="hover:text-gray-200 font-semibold border-b-2 border-white pb-1">
                            <i class="fas fa-certificate mr-1"></i>Certificates
                        </a>
                        <a href="/admin/centers" class="hover:text-gray-200">
                            <i class="fas fa-building mr-1"></i>Centers
                        </a>
                        <a href="/admin/programs" class="hover:text-gray-200">
                            <i class="fas fa-book mr-1"></i>Programs
                        </a>
                        <button onclick="logout()" class="hover:text-gray-200">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-certificate mr-2"></i>Certificate Management
                </h1>
                <button onclick="showAddModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i>Add Certificate
                </button>
            </div>

            <!-- Search Bar -->
            <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                <div class="flex gap-4">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Search by certificate number or holder name..."
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800">
                    <button onclick="searchCertificates()" class="bg-red-800 text-white px-6 py-2 rounded-lg hover:bg-red-900 transition">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                </div>
            </div>

            <!-- Certificates Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Certificate #</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Holder Name</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Program</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Issue Date</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="certificates-table" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Loading certificates...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-screen overflow-y-auto m-4">
                <div class="bg-red-800 text-white px-6 py-4 flex justify-between items-center">
                    <h2 id="modal-title" class="text-xl font-bold">Add New Certificate</h2>
                    <button onclick="closeModal()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="certificate-form" class="p-6 space-y-4">
                    <input type="hidden" id="cert-id">
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Certificate Number *</label>
                        <input type="text" id="cert-number" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800"
                            placeholder="e.g., MOGU-2024-001">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Holder Name *</label>
                        <input type="text" id="cert-holder" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800"
                            placeholder="Full name of certificate holder">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Training Center *</label>
                            <select id="cert-center" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800">
                                <option value="">Loading...</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Training Program *</label>
                            <select id="cert-program" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800">
                                <option value="">Select center first</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Issue Date *</label>
                            <input type="date" id="cert-issue-date" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Expiry Date</label>
                            <input type="date" id="cert-expiry-date"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800">
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Status *</label>
                        <select id="cert-status" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800">
                            <option value="valid">Valid</option>
                            <option value="expired">Expired</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-semibold">
                            <i class="fas fa-save mr-2"></i>Save Certificate
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-400 text-white py-2 rounded-lg hover:bg-gray-500 transition font-semibold">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
          let allCertificates = [];
          let allCenters = [];
          let allPrograms = [];

          // Load data on page load
          window.onload = async () => {
            await loadCenters();
            await loadPrograms();
            await loadCertificates();
          };

          async function loadCertificates() {
            try {
              const response = await axios.get('/api/admin/certificates');
              if (response.data.success) {
                allCertificates = response.data.certificates;
                displayCertificates(allCertificates);
              }
            } catch (error) {
              console.error('Error loading certificates:', error);
              alert('Error loading certificates');
            }
          }

          async function loadCenters() {
            try {
              const response = await axios.get('/api/admin/centers/list');
              if (response.data.success) {
                allCenters = response.data.centers;
                const select = document.getElementById('cert-center');
                select.innerHTML = '<option value="">Select center</option>';
                allCenters.forEach(center => {
                  select.innerHTML += \`<option value="\${center.id}">\${center.name}</option>\`;
                });
              }
            } catch (error) {
              console.error('Error loading centers:', error);
            }
          }

          async function loadPrograms() {
            try {
              const response = await axios.get('/api/admin/programs');
              if (response.data.success) {
                allPrograms = response.data.programs;
              }
            } catch (error) {
              console.error('Error loading programs:', error);
            }
          }

          // Update program dropdown based on selected center
          document.getElementById('cert-center').addEventListener('change', function() {
            const centerId = this.value;
            const programSelect = document.getElementById('cert-program');
            
            if (!centerId) {
              programSelect.innerHTML = '<option value="">Select center first</option>';
              return;
            }

            const centerPrograms = allPrograms.filter(p => p.center_id == centerId);
            programSelect.innerHTML = '<option value="">Select program</option>';
            centerPrograms.forEach(prog => {
              programSelect.innerHTML += \`<option value="\${prog.id}">\${prog.program_name} (\${prog.program_code})</option>\`;
            });
          });

          function displayCertificates(certificates) {
            const tbody = document.getElementById('certificates-table');
            
            if (certificates.length === 0) {
              tbody.innerHTML = \`
                <tr>
                  <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-inbox text-3xl mb-2"></i>
                    <p>No certificates found</p>
                  </td>
                </tr>
              \`;
              return;
            }

            tbody.innerHTML = certificates.map(cert => \`
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 font-mono text-sm">\${cert.certificate_number}</td>
                <td class="px-6 py-4">\${cert.holder_name}</td>
                <td class="px-6 py-4">
                  <div class="text-sm font-semibold">\${cert.program_name}</div>
                  <div class="text-xs text-gray-500">\${cert.training_center}</div>
                </td>
                <td class="px-6 py-4 text-sm">\${cert.issue_date}</td>
                <td class="px-6 py-4">
                  <span class="px-2 py-1 rounded-full text-xs font-semibold 
                    \${cert.status === 'valid' ? 'bg-green-100 text-green-800' : 
                      cert.status === 'expired' ? 'bg-red-100 text-red-800' : 
                      'bg-yellow-100 text-yellow-800'}">
                    \${cert.status.toUpperCase()}
                  </span>
                </td>
                <td class="px-6 py-4">
                  <button onclick="editCertificate(\${cert.id})" class="text-blue-600 hover:text-blue-800 mr-3" title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deleteCertificate(\${cert.id})" class="text-red-600 hover:text-red-800" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            \`).join('');
          }

          function showAddModal() {
            document.getElementById('modal-title').textContent = 'Add New Certificate';
            document.getElementById('certificate-form').reset();
            document.getElementById('cert-id').value = '';
            document.getElementById('modal').classList.remove('hidden');
          }

          function closeModal() {
            document.getElementById('modal').classList.add('hidden');
          }

          async function editCertificate(id) {
            const cert = allCertificates.find(c => c.id === id);
            if (!cert) return;

            document.getElementById('modal-title').textContent = 'Edit Certificate';
            document.getElementById('cert-id').value = cert.id;
            document.getElementById('cert-number').value = cert.certificate_number;
            document.getElementById('cert-holder').value = cert.holder_name;
            document.getElementById('cert-center').value = cert.center_id;
            
            // Trigger center change to load programs
            document.getElementById('cert-center').dispatchEvent(new Event('change'));
            
            setTimeout(() => {
              document.getElementById('cert-program').value = cert.program_id;
              document.getElementById('cert-issue-date').value = cert.issue_date;
              document.getElementById('cert-expiry-date').value = cert.expiry_date || '';
              document.getElementById('cert-status').value = cert.status;
            }, 100);

            document.getElementById('modal').classList.remove('hidden');
          }

          async function deleteCertificate(id) {
            if (!confirm('Are you sure you want to delete this certificate?')) return;

            try {
              const response = await axios.delete(\`/api/admin/certificates/\${id}\`);
              if (response.data.success) {
                alert('Certificate deleted successfully');
                await loadCertificates();
              }
            } catch (error) {
              console.error('Error deleting certificate:', error);
              alert('Error deleting certificate');
            }
          }

          document.getElementById('certificate-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('cert-id').value;
            const data = {
              certificate_number: document.getElementById('cert-number').value,
              holder_name: document.getElementById('cert-holder').value,
              center_id: parseInt(document.getElementById('cert-center').value),
              program_id: parseInt(document.getElementById('cert-program').value),
              issue_date: document.getElementById('cert-issue-date').value,
              expiry_date: document.getElementById('cert-expiry-date').value || null,
              status: document.getElementById('cert-status').value
            };

            try {
              let response;
              if (id) {
                response = await axios.put(\`/api/admin/certificates/\${id}\`, data);
              } else {
                response = await axios.post('/api/admin/certificates', data);
              }

              if (response.data.success) {
                alert(id ? 'Certificate updated successfully' : 'Certificate added successfully');
                closeModal();
                await loadCertificates();
              }
            } catch (error) {
              console.error('Error saving certificate:', error);
              alert('Error saving certificate');
            }
          });

          function searchCertificates() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (!searchTerm) {
              displayCertificates(allCertificates);
              return;
            }

            const filtered = allCertificates.filter(cert => 
              cert.certificate_number.toLowerCase().includes(searchTerm) ||
              cert.holder_name.toLowerCase().includes(searchTerm)
            );
            displayCertificates(filtered);
          }

          function logout() {
            axios.post('/api/admin/logout')
              .then(() => {
                document.cookie = 'admin_session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                window.location.href = '/admin/login';
              })
              .catch(error => console.error('Logout error:', error));
          }
        </script>
    </body>
    </html>
  `)
})


// ============================================
// ADMIN CENTERS MANAGEMENT PAGE
// ============================================

app.get('/admin/centers', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Manage Centers - MOGU Edu</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-100">
        <!-- Admin Navigation -->
        <nav class="bg-red-800 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <img src="/mogu-logo.png" alt="MOGU Edu" class="h-12">
                        <span class="ml-3 text-xl font-bold">Admin Panel</span>
                    </div>
                    <div class="flex items-center space-x-6">
                        <a href="/admin/dashboard" class="hover:text-gray-200">
                            <i class="fas fa-home mr-1"></i>Dashboard
                        </a>
                        <a href="/admin/certificates" class="hover:text-gray-200">
                            <i class="fas fa-certificate mr-1"></i>Certificates
                        </a>
                        <a href="/admin/centers" class="hover:text-gray-200 font-semibold border-b-2 border-white pb-1">
                            <i class="fas fa-building mr-1"></i>Centers
                        </a>
                        <a href="/admin/programs" class="hover:text-gray-200">
                            <i class="fas fa-book mr-1"></i>Programs
                        </a>
                        <button onclick="logout()" class="hover:text-gray-200">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-building mr-2"></i>Training Centers Management
                </h1>
                <button onclick="showAddModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i>Add Center
                </button>
            </div>

            <!-- Centers Grid -->
            <div id="centers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-3"></i>
                    <p class="text-gray-500">Loading centers...</p>
                </div>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl m-4">
                <div class="bg-red-800 text-white px-6 py-4 flex justify-between items-center">
                    <h2 id="modal-title" class="text-xl font-bold">Add New Center</h2>
                    <button onclick="closeModal()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="center-form" class="p-6 space-y-4">
                    <input type="hidden" id="center-id">
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Center Name *</label>
                        <input type="text" id="center-name" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800"
                            placeholder="Training center name">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Country *</label>
                            <input type="text" id="center-country" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800"
                                placeholder="e.g., Canada">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">City</label>
                            <input type="text" id="center-city"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800"
                                placeholder="City name">
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Website</label>
                        <input type="url" id="center-website"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800"
                            placeholder="https://example.com">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Accreditation Date *</label>
                        <input type="date" id="center-accred-date" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Status *</label>
                        <select id="center-status" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspended">Suspended</option>
                        </select>
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-semibold">
                            <i class="fas fa-save mr-2"></i>Save Center
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-400 text-white py-2 rounded-lg hover:bg-gray-500 transition font-semibold">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
          let allCenters = [];

          window.onload = async () => {
            await loadCenters();
          };

          async function loadCenters() {
            try {
              const response = await axios.get('/api/admin/centers');
              if (response.data.success) {
                allCenters = response.data.centers;
                displayCenters(allCenters);
              }
            } catch (error) {
              console.error('Error loading centers:', error);
              alert('Error loading centers');
            }
          }

          function displayCenters(centers) {
            const grid = document.getElementById('centers-grid');
            
            if (centers.length === 0) {
              grid.innerHTML = \`
                <div class="col-span-full text-center py-12">
                  <i class="fas fa-inbox text-4xl text-gray-400 mb-3"></i>
                  <p class="text-gray-500">No centers found</p>
                </div>
              \`;
              return;
            }

            grid.innerHTML = centers.map(center => \`
              <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
                <div class="flex items-start justify-between mb-4">
                  <div class="flex-1">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">\${center.name}</h3>
                    <p class="text-sm text-gray-600">
                      <i class="fas fa-map-marker-alt mr-1"></i>
                      \${center.city ? center.city + ', ' : ''}\${center.country}
                    </p>
                  </div>
                  <span class="px-3 py-1 rounded-full text-xs font-semibold
                    \${center.accreditation_status === 'active' ? 'bg-green-100 text-green-800' : 
                      center.accreditation_status === 'suspended' ? 'bg-yellow-100 text-yellow-800' : 
                      'bg-red-100 text-red-800'}">
                    \${center.accreditation_status.toUpperCase()}
                  </span>
                </div>

                <div class="space-y-2 mb-4">
                  <p class="text-sm text-gray-600">
                    <i class="fas fa-calendar mr-2"></i>
                    Accredited: \${center.accreditation_date}
                  </p>
                  \${center.website ? \`
                    <p class="text-sm text-blue-600 hover:underline">
                      <i class="fas fa-globe mr-2"></i>
                      <a href="\${center.website}" target="_blank">\${center.website}</a>
                    </p>
                  \` : ''}
                </div>

                <div class="flex gap-2 pt-4 border-t">
                  <button onclick="editCenter(\${center.id})" class="flex-1 bg-blue-50 text-blue-600 px-4 py-2 rounded hover:bg-blue-100 transition">
                    <i class="fas fa-edit mr-1"></i>Edit
                  </button>
                  <button onclick="deleteCenter(\${center.id})" class="flex-1 bg-red-50 text-red-600 px-4 py-2 rounded hover:bg-red-100 transition">
                    <i class="fas fa-trash mr-1"></i>Delete
                  </button>
                </div>
              </div>
            \`).join('');
          }

          function showAddModal() {
            document.getElementById('modal-title').textContent = 'Add New Center';
            document.getElementById('center-form').reset();
            document.getElementById('center-id').value = '';
            document.getElementById('modal').classList.remove('hidden');
          }

          function closeModal() {
            document.getElementById('modal').classList.add('hidden');
          }

          async function editCenter(id) {
            const center = allCenters.find(c => c.id === id);
            if (!center) return;

            document.getElementById('modal-title').textContent = 'Edit Center';
            document.getElementById('center-id').value = center.id;
            document.getElementById('center-name').value = center.name;
            document.getElementById('center-country').value = center.country;
            document.getElementById('center-city').value = center.city || '';
            document.getElementById('center-website').value = center.website || '';
            document.getElementById('center-accred-date').value = center.accreditation_date;
            document.getElementById('center-status').value = center.accreditation_status;

            document.getElementById('modal').classList.remove('hidden');
          }

          async function deleteCenter(id) {
            if (!confirm('Are you sure you want to delete this center? This will affect related certificates and programs.')) return;

            try {
              const response = await axios.delete(\`/api/admin/centers/\${id}\`);
              if (response.data.success) {
                alert('Center deleted successfully');
                await loadCenters();
              }
            } catch (error) {
              console.error('Error deleting center:', error);
              alert('Error deleting center');
            }
          }

          document.getElementById('center-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('center-id').value;
            const data = {
              name: document.getElementById('center-name').value,
              country: document.getElementById('center-country').value,
              city: document.getElementById('center-city').value || null,
              website: document.getElementById('center-website').value || null,
              accreditation_date: document.getElementById('center-accred-date').value,
              accreditation_status: document.getElementById('center-status').value
            };

            try {
              let response;
              if (id) {
                response = await axios.put(\`/api/admin/centers/\${id}\`, data);
              } else {
                response = await axios.post('/api/admin/centers', data);
              }

              if (response.data.success) {
                alert(id ? 'Center updated successfully' : 'Center added successfully');
                closeModal();
                await loadCenters();
              }
            } catch (error) {
              console.error('Error saving center:', error);
              alert('Error saving center');
            }
          });

          function logout() {
            axios.post('/api/admin/logout')
              .then(() => {
                document.cookie = 'admin_session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                window.location.href = '/admin/login';
              })
              .catch(error => console.error('Logout error:', error));
          }
        </script>
    </body>
    </html>
  `)
})


// ============================================
// ADMIN PROGRAMS MANAGEMENT PAGE
// ============================================

app.get('/admin/programs', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Manage Programs - MOGU Edu</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-100">
        <!-- Admin Navigation -->
        <nav class="bg-red-800 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <img src="/mogu-logo.png" alt="MOGU Edu" class="h-12">
                        <span class="ml-3 text-xl font-bold">Admin Panel</span>
                    </div>
                    <div class="flex items-center space-x-6">
                        <a href="/admin/dashboard" class="hover:text-gray-200">
                            <i class="fas fa-home mr-1"></i>Dashboard
                        </a>
                        <a href="/admin/certificates" class="hover:text-gray-200">
                            <i class="fas fa-certificate mr-1"></i>Certificates
                        </a>
                        <a href="/admin/centers" class="hover:text-gray-200">
                            <i class="fas fa-building mr-1"></i>Centers
                        </a>
                        <a href="/admin/programs" class="hover:text-gray-200 font-semibold border-b-2 border-white pb-1">
                            <i class="fas fa-book mr-1"></i>Programs
                        </a>
                        <button onclick="logout()" class="hover:text-gray-200">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-book mr-2"></i>Training Programs Management
                </h1>
                <button onclick="showAddModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i>Add Program
                </button>
            </div>

            <!-- Programs Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Program Name</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Code</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Training Center</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Accredited Date</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="programs-table" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin text-3xl mb-2"></i>
                                <p>Loading programs...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add/Edit Modal -->
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl m-4">
                <div class="bg-red-800 text-white px-6 py-4 flex justify-between items-center">
                    <h2 id="modal-title" class="text-xl font-bold">Add New Program</h2>
                    <button onclick="closeModal()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="program-form" class="p-6 space-y-4">
                    <input type="hidden" id="program-id">
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Program Name *</label>
                        <input type="text" id="program-name" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800"
                            placeholder="e.g., Project Management Professional">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Program Code *</label>
                            <input type="text" id="program-code" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800"
                                placeholder="e.g., PMP-2024">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Training Center *</label>
                            <select id="program-center" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Accreditation Date *</label>
                        <input type="date" id="program-accred-date" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Status *</label>
                        <select id="program-status" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-800">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition font-semibold">
                            <i class="fas fa-save mr-2"></i>Save Program
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-400 text-white py-2 rounded-lg hover:bg-gray-500 transition font-semibold">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
        <script>
          let allPrograms = [];
          let allCenters = [];

          window.onload = async () => {
            await loadCenters();
            await loadPrograms();
          };

          async function loadCenters() {
            try {
              const response = await axios.get('/api/admin/centers/list');
              if (response.data.success) {
                allCenters = response.data.centers;
                const select = document.getElementById('program-center');
                select.innerHTML = '<option value="">Select center</option>';
                allCenters.forEach(center => {
                  select.innerHTML += \`<option value="\${center.id}">\${center.name}</option>\`;
                });
              }
            } catch (error) {
              console.error('Error loading centers:', error);
            }
          }

          async function loadPrograms() {
            try {
              const response = await axios.get('/api/admin/programs');
              if (response.data.success) {
                allPrograms = response.data.programs;
                displayPrograms(allPrograms);
              }
            } catch (error) {
              console.error('Error loading programs:', error);
              alert('Error loading programs');
            }
          }

          function displayPrograms(programs) {
            const tbody = document.getElementById('programs-table');
            
            if (programs.length === 0) {
              tbody.innerHTML = \`
                <tr>
                  <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-inbox text-3xl mb-2"></i>
                    <p>No programs found</p>
                  </td>
                </tr>
              \`;
              return;
            }

            tbody.innerHTML = programs.map(prog => \`
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 font-semibold">\${prog.program_name}</td>
                <td class="px-6 py-4 font-mono text-sm">\${prog.program_code}</td>
                <td class="px-6 py-4 text-sm">\${prog.center_name}</td>
                <td class="px-6 py-4 text-sm">\${prog.accreditation_date}</td>
                <td class="px-6 py-4">
                  <span class="px-2 py-1 rounded-full text-xs font-semibold 
                    \${prog.accreditation_status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    \${prog.accreditation_status.toUpperCase()}
                  </span>
                </td>
                <td class="px-6 py-4">
                  <button onclick="editProgram(\${prog.id})" class="text-blue-600 hover:text-blue-800 mr-3" title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deleteProgram(\${prog.id})" class="text-red-600 hover:text-red-800" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            \`).join('');
          }

          function showAddModal() {
            document.getElementById('modal-title').textContent = 'Add New Program';
            document.getElementById('program-form').reset();
            document.getElementById('program-id').value = '';
            document.getElementById('modal').classList.remove('hidden');
          }

          function closeModal() {
            document.getElementById('modal').classList.add('hidden');
          }

          async function editProgram(id) {
            const prog = allPrograms.find(p => p.id === id);
            if (!prog) return;

            document.getElementById('modal-title').textContent = 'Edit Program';
            document.getElementById('program-id').value = prog.id;
            document.getElementById('program-name').value = prog.program_name;
            document.getElementById('program-code').value = prog.program_code;
            document.getElementById('program-center').value = prog.center_id;
            document.getElementById('program-accred-date').value = prog.accreditation_date;
            document.getElementById('program-status').value = prog.accreditation_status;

            document.getElementById('modal').classList.remove('hidden');
          }

          async function deleteProgram(id) {
            if (!confirm('Are you sure you want to delete this program?')) return;

            try {
              const response = await axios.delete(\`/api/admin/programs/\${id}\`);
              if (response.data.success) {
                alert('Program deleted successfully');
                await loadPrograms();
              }
            } catch (error) {
              console.error('Error deleting program:', error);
              alert('Error deleting program');
            }
          }

          document.getElementById('program-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('program-id').value;
            const data = {
              program_name: document.getElementById('program-name').value,
              program_code: document.getElementById('program-code').value,
              center_id: parseInt(document.getElementById('program-center').value),
              accreditation_date: document.getElementById('program-accred-date').value,
              accreditation_status: document.getElementById('program-status').value
            };

            try {
              let response;
              if (id) {
                response = await axios.put(\`/api/admin/programs/\${id}\`, data);
              } else {
                response = await axios.post('/api/admin/programs', data);
              }

              if (response.data.success) {
                alert(id ? 'Program updated successfully' : 'Program added successfully');
                closeModal();
                await loadPrograms();
              }
            } catch (error) {
              console.error('Error saving program:', error);
              alert('Error saving program');
            }
          });

          function logout() {
            axios.post('/api/admin/logout')
              .then(() => {
                document.cookie = 'admin_session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
                window.location.href = '/admin/login';
              })
              .catch(error => console.error('Logout error:', error));
          }
        </script>
    </body>
    </html>
  `)
})


// ============================================
// ADDITIONAL ADMIN API ROUTES FOR CENTERS
// ============================================

app.get('/api/admin/centers', async (c) => {
  const { DB } = c.env;
  try {
    const stmt = DB.prepare(`
      SELECT * FROM training_centers ORDER BY name
    `);
    const { results } = await stmt.all();
    return c.json({ success: true, centers: results || [] });
  } catch (error) {
    return c.json({ success: false, message: 'Error fetching centers' }, 500);
  }
});

app.post('/api/admin/centers', async (c) => {
  const { DB } = c.env;
  const data = await c.req.json();
  try {
    const result = await DB.prepare(`
      INSERT INTO training_centers (name, country, city, website, accreditation_date, accreditation_status)
      VALUES (?, ?, ?, ?, ?, ?)
    `).bind(
      data.name,
      data.country,
      data.city || null,
      data.website || null,
      data.accreditation_date,
      data.accreditation_status || 'active'
    ).run();
    return c.json({ success: true, id: result.meta.last_row_id });
  } catch (error) {
    return c.json({ success: false, message: 'Error adding center' }, 500);
  }
});

app.put('/api/admin/centers/:id', async (c) => {
  const { DB } = c.env;
  const id = c.req.param('id');
  const data = await c.req.json();
  try {
    await DB.prepare(`
      UPDATE training_centers 
      SET name = ?, country = ?, city = ?, website = ?, 
          accreditation_date = ?, accreditation_status = ?, updated_at = datetime('now')
      WHERE id = ?
    `).bind(
      data.name,
      data.country,
      data.city || null,
      data.website || null,
      data.accreditation_date,
      data.accreditation_status,
      id
    ).run();
    return c.json({ success: true });
  } catch (error) {
    return c.json({ success: false, message: 'Error updating center' }, 500);
  }
});

app.delete('/api/admin/centers/:id', async (c) => {
  const { DB } = c.env;
  const id = c.req.param('id');
  try {
    await DB.prepare(`DELETE FROM training_centers WHERE id = ?`).bind(id).run();
    return c.json({ success: true });
  } catch (error) {
    return c.json({ success: false, message: 'Error deleting center' }, 500);
  }
});


// ============================================
// ADDITIONAL ADMIN API ROUTES FOR PROGRAMS
// ============================================

app.post('/api/admin/programs', async (c) => {
  const { DB } = c.env;
  const data = await c.req.json();
  try {
    const result = await DB.prepare(`
      INSERT INTO training_programs (program_name, program_code, center_id, accreditation_date, accreditation_status)
      VALUES (?, ?, ?, ?, ?)
    `).bind(
      data.program_name,
      data.program_code,
      data.center_id,
      data.accreditation_date,
      data.accreditation_status || 'active'
    ).run();
    return c.json({ success: true, id: result.meta.last_row_id });
  } catch (error) {
    return c.json({ success: false, message: 'Error adding program' }, 500);
  }
});

app.put('/api/admin/programs/:id', async (c) => {
  const { DB } = c.env;
  const id = c.req.param('id');
  const data = await c.req.json();
  try {
    await DB.prepare(`
      UPDATE training_programs 
      SET program_name = ?, program_code = ?, center_id = ?, 
          accreditation_date = ?, accreditation_status = ?, updated_at = datetime('now')
      WHERE id = ?
    `).bind(
      data.program_name,
      data.program_code,
      data.center_id,
      data.accreditation_date,
      data.accreditation_status,
      id
    ).run();
    return c.json({ success: true });
  } catch (error) {
    return c.json({ success: false, message: 'Error updating program' }, 500);
  }
});

app.delete('/api/admin/programs/:id', async (c) => {
  const { DB } = c.env;
  const id = c.req.param('id');
  try {
    await DB.prepare(`DELETE FROM training_programs WHERE id = ?`).bind(id).run();
    return c.json({ success: true });
  } catch (error) {
    return c.json({ success: false, message: 'Error deleting program' }, 500);
  }
});
